<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Generador y Lector de C√≥digos de Barras y QR</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsbarcode/3.11.5/JsBarcode.all.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        /* CSS completo para estilo moderno y funcional */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        .tab {
            padding: 15px 25px;
            background: none;
            border: none;
            font-size: 1em;
            cursor: pointer;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        .tab:hover {
            color: #667eea;
        }
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .input-group {
            margin-bottom: 25px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 1em;
        }
        input, select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1em;
            transition: border-color 0.3s;
            font-family: inherit;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 20px;
        }
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }
        .btn:active {
            transform: translateY(0);
        }
        .btn-stop {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }
        .btn-stop:hover {
            box-shadow: 0 10px 20px rgba(220, 53, 69, 0.4);
        }
        .result {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 10px;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #qrcode {
            margin: 20px auto;
        }
        #barcode {
            margin: 20px auto;
        }
        .download-btn {
            margin-top: 20px;
            padding: 10px 30px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
        }
        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
        }
        .empty-state {
            color: #999;
            font-size: 1.1em;
        }
        .format-info {
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.9em;
            color: #0066cc;
        }
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            transition: background 0.3s;
        }
        .checkbox-label:hover {
            background: #e9ecef;
        }
        .checkbox-label input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }
        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px solid #e0e0e0;
        }
        .history-title {
            font-size: 1.3em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }
        .history-list {
            max-height: 200px;
            overflow-y: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .history-item {
            padding: 10px;
            background: white;
            margin-bottom: 8px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.95em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .history-empty {
            text-align: center;
            color: #999;
            padding: 20px;
        }
        .copy-btn {
            padding: 5px 15px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .copy-btn:hover {
            background: #5568d3;
        }
        /* Estilos para el lector */
        #reader {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            border-radius: 10px;
            overflow: hidden;
        }
        .scanned-result {
            margin-top: 20px;
            padding: 20px;
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            word-break: break-word;
            text-align: left;
        }
        .scanned-result h3 {
            color: #155724;
            margin-bottom: 10px;
        }
        .scanned-result p {
            color: #155724;
            font-family: monospace;
            font-size: 1.1em;
            margin: 0;
            white-space: pre-wrap;
        }
        .scanner-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .scanner-controls button {
            flex: 1;
            max-width: 150px;
        }
        .udi-parsed {
            margin-top: 15px;
            padding: 15px;
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 8px;
            text-align: left;
        }
        .udi-parsed h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        .udi-field {
            padding: 5px 0;
            color: #856404;
        }
        .udi-field strong {
            display: inline-block;
            min-width: 180px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî≤ Generador y Lector de C√≥digos</h1>
        <p class="subtitle">Crea y lee c√≥digos QR, de barras y UDI f√°cilmente</p>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('generate-qr')">Generar QR</button>
            <button class="tab" onclick="switchTab('generate-barcode')">Generar C√≥digo de Barras</button>
            <button class="tab" onclick="switchTab('scan')">üì∑ Escanear C√≥digos</button>
        </div>

        <!-- Generar QR -->
        <div id="generate-qr-tab" class="tab-content active">
            <div class="format-info">
                üí° Los c√≥digos QR pueden contener texto, URLs, n√∫meros de tel√©fono, emails, UDI m√©dicos, etc.
            </div>
            <div class="input-group">
                <label for="qr-mode">Tipo de contenido:</label>
                <select id="qr-mode" onchange="changeQRMode()">
                    <option value="text">Texto libre</option>
                    <option value="url">URL/Enlace web</option>
                    <option value="udi">UDI (Unique Device Identifier)</option>
                </select>
            </div>
            <div id="qr-text-input" class="input-group">
                <label for="qr-text">Texto o URL para el c√≥digo QR:</label>
                <input type="text" id="qr-text" placeholder="Ej: https://www.ejemplo.com o cualquier texto" />
            </div>
            <div id="qr-udi-input" class="input-group" style="display: none;">
                <label for="udi-di">DI (Device Identifier):</label>
                <input type="text" id="udi-di" placeholder="Ej: (01)00614141123456" />
                <label for="udi-lot">Lote:</label>
                <input type="text" id="udi-lot" placeholder="Ej: (10)ABC123" />
                <label for="udi-serial">N√∫mero de serie:</label>
                <input type="text" id="udi-serial" placeholder="Ej: (21)123456789" />
                <label for="udi-expiry">Fecha de expiraci√≥n (YYMMDD):</label>
                <input type="text" id="udi-expiry" placeholder="Ej: (17)251231" />
                <label for="udi-manufacture">Fecha de fabricaci√≥n (YYMMDD):</label>
                <input type="text" id="udi-manufacture" placeholder="Ej: (11)240101" />
                <div class="format-info" style="margin-top: 15px;">
                    ‚ÑπÔ∏è El UDI se formatear√° autom√°ticamente seg√∫n est√°ndares GS1. Solo completa los campos necesarios.
                </div>
            </div>
            <button class="btn" onclick="generateQR()">Generar C√≥digo QR</button>
            <div class="result">
                <div id="qrcode"></div>
                <div id="qr-empty" class="empty-state">Ingresa un texto y haz clic en generar</div>
                <button id="qr-download" class="download-btn" style="display: none;" onclick="downloadQR()">Descargar QR como PNG</button>
            </div>
        </div>

        <!-- Generar C√≥digo de Barras -->
        <div id="generate-barcode-tab" class="tab-content">
            <div class="format-info">
                üí° Los c√≥digos de barras requieren n√∫meros. Formatos: EAN-13 (13 d√≠gitos), CODE128 (alfanum√©rico), UPC (12 d√≠gitos)
            </div>
            <div class="input-group">
                <label for="barcode-format">Formato de c√≥digo de barras:</label>
                <select id="barcode-format">
                    <option value="CODE128">CODE128 (Alfanum√©rico)</option>
                    <option value="EAN13">EAN-13 (13 d√≠gitos)</option>
                    <option value="UPC">UPC (12 d√≠gitos)</option>
                    <option value="CODE39">CODE39</option>
                </select>
            </div>
            <div class="input-group">
                <label for="barcode-text">Texto para el c√≥digo de barras:</label>
                <input type="text" id="barcode-text" placeholder="Ej: 1234567890128" />
            </div>
            <div class="input-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="random-barcode" onchange="toggleRandomBarcode()" />
                    <span>Generar c√≥digo aleatorio √∫nico</span>
                </label>
            </div>
            <button class="btn" onclick="generateBarcode()">Generar C√≥digo de Barras</button>
            <div class="result">
                <svg id="barcode"></svg>
                <div id="barcode-empty" class="empty-state">Ingresa un c√≥digo y haz clic en generar</div>
                <button id="barcode-download" class="download-btn" style="display: none;" onclick="downloadBarcode()">Descargar C√≥digo de Barras</button>
            </div>
            <div class="history-section">
                <div class="history-title">üìã Historial de C√≥digos Generados</div>
                <div class="history-list" id="history-list">
                    <div class="history-empty">No hay c√≥digos generados a√∫n</div>
                </div>
            </div>
        </div>

        <!-- Escanear C√≥digos -->
        <div id="scan-tab" class="tab-content">
            <div class="format-info">
                üì∑ Escanea c√≥digos QR, c√≥digos de barras y UDI usando tu c√°mara o subiendo una imagen
            </div>

            <div class="scanner-controls">
                <button class="btn" onclick="startScanner()">Iniciar C√°mara</button>
                <button class="btn btn-stop" onclick="stopScanner()" style="display: none;" id="stop-btn">Detener C√°mara</button>
            </div>

            <div class="input-group">
                <label for="file-input">O sube una imagen con el c√≥digo:</label>
                <input type="file" id="file-input" accept="image/*" onchange="scanFromFile(event)" />
            </div>

            <div id="reader" style="display: none;"></div>

            <div id="scanned-output"></div>
        </div>
    </div>

    <script>
        let qrCode = null;
        let generatedCodes = new Set();
        const STORAGE_KEY = 'generated_barcodes_history';
        let html5QrCode = null;
        let isScanning = false;

        // Cargar historial al iniciar
        function loadHistory() {
            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) {
                generatedCodes = new Set(JSON.parse(saved));
                updateHistoryDisplay();
            }
        }

        // Cambiar modo de QR
        function changeQRMode() {
            const mode = document.getElementById('qr-mode').value;
            const textInput = document.getElementById('qr-text-input');
            const udiInput = document.getElementById('qr-udi-input');

            if (mode === 'udi') {
                textInput.style.display = 'none';
                udiInput.style.display = 'block';
            } else {
                textInput.style.display = 'block';
                udiInput.style.display = 'none';

                if (mode === 'url') {
                    document.getElementById('qr-text').placeholder = 'Ej: https://www.ejemplo.com';
                } else {
                    document.getElementById('qr-text').placeholder = 'Ej: Cualquier texto';
                }
            }
        }

        // Construir UDI seg√∫n formato GS1
        function buildUDI() {
            const di = document.getElementById('udi-di').value.trim();
            const lot = document.getElementById('udi-lot').value.trim();
            const serial = document.getElementById('udi-serial').value.trim();
            const expiry = document.getElementById('udi-expiry').value.trim();
            const manufacture = document.getElementById('udi-manufacture').value.trim();

            if (!di) {
                alert('El Device Identifier (DI) es obligatorio para el UDI');
                return null;
            }

            let udi = di;
            if (lot) udi += lot;
            if (serial) udi += serial;
            if (expiry) udi += expiry;
            if (manufacture) udi += manufacture;

            return udi;
        }

        // Parsear UDI escaneado
        function parseUDI(udiString) {
            const patterns = {
                '01': 'Device Identifier (GTIN)',
                '10': 'Lote',
                '21': 'N√∫mero de Serie',
                '17': 'Fecha de Expiraci√≥n',
                '11': 'Fecha de Fabricaci√≥n',
                '240': 'Informaci√≥n Adicional'
            };

            const parsed = {};
            for (const [code, label] of Object.entries(patterns)) {
                const regex = new RegExp(`\\(${code}\\)([^\\(]+)`);
                const match = udiString.match(regex);
                if (match) {
                    parsed[label] = match[1].trim();
                }
            }

            return Object.keys(parsed).length > 0 ? parsed : null;
        }

        // Guardar historial
        function saveHistory() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify([...generatedCodes]));
        }

        // Actualizar visualizaci√≥n del historial
        function updateHistoryDisplay() {
            const historyList = document.getElementById('history-list');

            if (generatedCodes.size === 0) {
                historyList.innerHTML = '<div class="history-empty">No hay c√≥digos generados a√∫n</div>';
                return;
            }

            const codes = [...generatedCodes].reverse().slice(0, 50);
            historyList.innerHTML = codes
                .map(
                    (code) => `
                <div class="history-item">
                    <span>${code}</span>
                    <button class="copy-btn" onclick="copyToClipboard('${code}')">Copiar</button>
                </div>`
                )
                .join('');
        }

        // Copiar al portapapeles
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('C√≥digo copiado: ' + text);
            });
        }

        // Generar c√≥digo √∫nico seg√∫n formato
        function generateUniqueCode(format) {
            let code;
            let attempts = 0;
            const maxAttempts = 1000;

            do {
                switch (format) {
                    case 'EAN13':
                        code = generateEAN13();
                        break;
                    case 'UPC':
                        code = generateUPC();
                        break;
                    case 'CODE128':
                        code = generateCODE128();
                        break;
                    case 'CODE39':
                        code = generateCODE39();
                        break;
                    default:
                        code = generateCODE128();
                }
                attempts++;

                if (attempts >= maxAttempts) {
                    alert('No se pudo generar un c√≥digo √∫nico despu√©s de ' + maxAttempts + ' intentos. Intenta con otro formato.');
                    return null;
                }
            } while (generatedCodes.has(code));

            return code;
        }

        function generateEAN13() {
            let code = '';
            for (let i = 0; i < 12; i++) {
                code += Math.floor(Math.random() * 10);
            }

            let sum = 0;
            for (let i = 0; i < 12; i++) {
                sum += parseInt(code[i]) * (i % 2 === 0 ? 1 : 3);
            }
            const checksum = (10 - (sum % 10)) % 10;

            return code + checksum;
        }

        function generateUPC() {
            let code = '';
            for (let i = 0; i < 11; i++) {
                code += Math.floor(Math.random() * 10);
            }

            let sum = 0;
            for (let i = 0; i < 11; i++) {
                sum += parseInt(code[i]) * (i % 2 === 0 ? 3 : 1);
            }
            const checksum = (10 - (sum % 10)) % 10;

            return code + checksum;
        }

        function generateCODE128() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const length = 10 + Math.floor(Math.random() * 6);
            let code = '';

            for (let i = 0; i < length; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            return code;
        }

        function generateCODE39() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const length = 8 + Math.floor(Math.random() * 5);
            let code = '';

            for (let i = 0; i < length; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }

            return code;
        }

        function toggleRandomBarcode() {
            const checkbox = document.getElementById('random-barcode');
            const input = document.getElementById('barcode-text');
            input.disabled = checkbox.checked;

            if (checkbox.checked) {
                input.value = '';
                input.placeholder = 'Se generar√° autom√°ticamente';
            } else {
                input.placeholder = 'Ej: 1234567890128';
            }
        }

        function switchTab(tab) {
            if (isScanning) {
                stopScanner();
            }

            const tabs = document.querySelectorAll('.tab');
            const contents = document.querySelectorAll('.tab-content');

            tabs.forEach((t) => t.classList.remove('active'));
            contents.forEach((c) => c.classList.remove('active'));

            if (tab === 'generate-qr') {
                tabs[0].classList.add('active');
                document.getElementById('generate-qr-tab').classList.add('active');
            } else if (tab === 'generate-barcode') {
                tabs[1].classList.add('active');
                document.getElementById('generate-barcode-tab').classList.add('active');
            } else if (tab === 'scan') {
                tabs[2].classList.add('active');
                document.getElementById('scan-tab').classList.add('active');
            }
        }

        function generateQR() {
            const mode = document.getElementById('qr-mode').value;
            let text = '';

            if (mode === 'udi') {
                text = buildUDI();
                if (!text) return;
            } else {
                text = document.getElementById('qr-text').value.trim();
            }

            if (!text) {
                alert('Por favor ingresa un texto o completa los campos del UDI');
                return;
            }

            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            document.getElementById('qr-empty').style.display = 'none';

            qrCode = new QRCode(qrDiv, {
                text: text,
                width: 300,
                height: 300,
                colorDark: "#000000",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H,
            });

            setTimeout(() => {
                document.getElementById('qr-download').style.display = 'inline-block';
            }, 100);
        }

        function generateBarcode() {
            const checkbox = document.getElementById('random-barcode');
            let text = document.getElementById('barcode-text').value.trim();
            const format = document.getElementById('barcode-format').value;

            if (checkbox.checked) {
                text = generateUniqueCode(format);
                if (!text) return;
                document.getElementById('barcode-text').value = text;
            }

            if (!text) {
                alert('Por favor ingresa un c√≥digo o activa la generaci√≥n aleatoria');
                return;
            }

            if (generatedCodes.has(text)) {
                if (!checkbox.checked) {
                    alert(
                        'Este c√≥digo ya fue generado anteriormente. Usa la opci√≥n de generaci√≥n aleatoria para crear uno √∫nico.'
                    );
                    return;
                }
            }

            document.getElementById('barcode-empty').style.display = 'none';

            try {
                JsBarcode("#barcode", text, {
                    format: format,
                    width: 2,
                    height: 100,
                    displayValue: true,
                    fontSize: 14,
                    margin: 10,
                });

                generatedCodes.add(text);
                saveHistory();
                updateHistoryDisplay();

                document.getElementById('barcode-download').style.display = 'inline-block';
            } catch (e) {
                alert('Error: ' + e.message + '\n\nVerifica que el c√≥digo sea v√°lido para el formato seleccionado.');
                document.getElementById('barcode-empty').style.display = 'block';
            }
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (!canvas) {
                alert('Por favor genera un c√≥digo QR primero');
                return;
            }

            try {
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');

                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                ctx.drawImage(canvas, 0, 0);

                tempCanvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    const timestamp = new Date().getTime();
                    link.download = 'codigo-qr-' + timestamp + '.png';
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 'image/png');
            } catch (e) {
                alert('Error al descargar: ' + e.message);
            }
        }

        function downloadBarcode() {
            const svg = document.getElementById('barcode');
            if (!svg || !svg.querySelector('rect')) {
                alert('Por favor genera un c√≥digo de barras primero');
                return;
            }

            try {
                const svgData = new XMLSerializer().serializeToString(svg);
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();

                img.onload = function () {
                    canvas.width = img.width;
                    canvas.height = img.height;

                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);

                    canvas.toBlob(function (blob) {
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        const timestamp = new Date().getTime();
                        link.download = 'codigo-barras-' + timestamp + '.png';
                        link.href = url;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);
                    }, 'image/png');
                };

                img.onerror = function () {
                    alert('Error al cargar la imagen del c√≥digo de barras');
                };

                img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
            } catch (e) {
                alert('Error al descargar: ' + e.message);
            }
        }

        // ====== FUNCIONES DE ESCANEO ======

        function startScanner() {
            if (isScanning) return;

            const readerDiv = document.getElementById('reader');
            readerDiv.style.display = 'block';
            readerDiv.innerHTML = '';

            document.querySelector('.scanner-controls .btn').style.display = 'none';
            document.getElementById('stop-btn').style.display = 'inline-block';

            html5QrCode = new Html5Qrcode("reader");

            const config = { fps: 10, qrbox: 250 };

            html5QrCode
                .start(
                    { facingMode: "environment" },
                    config,
                    (decodedText, decodedResult) => {
                        displayScannedResult(
                            decodedText,
                            decodedResult.result.format.formatName || 'QR/BARCODE'
                        );
                        // Para detener autom√°ticamente despu√©s de un escaneo exitoso, descomenta la l√≠nea siguiente:
                        // stopScanner();
                    },
                    (errorMessage) => {
                        // Ignorar errores de escaneo menores
                    }
                )
                .then(() => {
                    isScanning = true;
                })
                .catch((err) => {
                    alert('Error al iniciar el esc√°ner: ' + err);
                    stopScanner();
                });
        }

        function stopScanner() {
            if (!isScanning || !html5QrCode) return;

            html5QrCode
                .stop()
                .then(() => {
                    html5QrCode.clear();
                    document.getElementById('reader').style.display = 'none';
                    document.querySelector('.scanner-controls .btn').style.display = 'inline-block';
                    document.getElementById('stop-btn').style.display = 'none';
                    isScanning = false;
                })
                .catch((err) => {
                    console.error('Error al detener el esc√°ner:', err);
                    alert('Error al detener el esc√°ner: ' + err);
                });
        }

        function scanFromFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Detener esc√°ner si activo
            if (isScanning) stopScanner();

            const html5QrCodeForFile = new Html5Qrcode("reader");

            html5QrCodeForFile
                .scanFile(file, true)
                .then((decodedText) => {
                    displayScannedResult(decodedText, 'FILE IMAGE');
                    html5QrCodeForFile.clear();
                    document.getElementById('reader').style.display = 'none';
                })
                .catch((err) => {
                    alert('Error al escanear la imagen: ' + err);
                });
        }

        function displayScannedResult(text, format) {
            const outputDiv = document.getElementById('scanned-output');
            let safeText = text.replace(/'/g, "\\'");
            let html = `
                <div class="scanned-result">
                    <h3>‚úÖ C√≥digo Escaneado</h3>
                    <p><strong>Formato:</strong> ${format}</p>
                    <p><strong>Contenido:</strong> ${text}</p>
                    <button class="download-btn" onclick="copyToClipboard('${safeText}')">Copiar Contenido</button>
                    <button class="download-btn" onclick="generateFromScanned('${safeText}', '${format}')">Generar desde Este C√≥digo</button>
                </div>
            `;

            const udiParsed = parseUDI(text);
            if (udiParsed) {
                html += `<div class="udi-parsed"><h4>üè• Informaci√≥n UDI Detectada:</h4>`;
                for (const [label, value] of Object.entries(udiParsed)) {
                    html += `<div class="udi-field"><strong>${label}:</strong> ${value}</div>`;
                }
                html += `</div>`;
            }

            outputDiv.innerHTML = html;
        }

        function generateFromScanned(text, format) {
            if (format.includes('QR')) {
                switchTab('generate-qr');
                document.getElementById('qr-text').value = text;

                if (text.includes('(01)') || text.includes('(10)')) {
                    document.getElementById('qr-mode').value = 'udi';
                    changeQRMode();

                    const parsed = parseUDI(text);
                    if (parsed) {
                        if (parsed['Device Identifier (GTIN)']) {
                            document.getElementById('udi-di').value = '(01)' + parsed['Device Identifier (GTIN)'];
                        }
                        if (parsed['Lote']) {
                            document.getElementById('udi-lot').value = '(10)' + parsed['Lote'];
                        }
                        if (parsed['N√∫mero de Serie']) {
                            document.getElementById('udi-serial').value = '(21)' + parsed['N√∫mero de Serie'];
                        }
                        if (parsed['Fecha de Expiraci√≥n']) {
                            document.getElementById('udi-expiry').value = '(17)' + parsed['Fecha de Expiraci√≥n'];
                        }
                        if (parsed['Fecha de Fabricaci√≥n']) {
                            document.getElementById('udi-manufacture').value = '(11)' + parsed['Fecha de Fabricaci√≥n'];
                        }
                    }
                }
                generateQR();
            } else {
                switchTab('generate-barcode');
                document.getElementById('barcode-text').value = text;

                if (text.length === 13 && /^\d+$/.test(text)) {
                    document.getElementById('barcode-format').value = 'EAN13';
                } else if (text.length === 12 && /^\d+$/.test(text)) {
                    document.getElementById('barcode-format').value = 'UPC';
                } else if (/^[A-Z0-9]+$/.test(text)) {
                    document.getElementById('barcode-format').value = 'CODE39';
                } else {
                    document.getElementById('barcode-format').value = 'CODE128';
                }
                generateBarcode();
            }
        }

        window.onload = function () {
            loadHistory();
        };
    </script>
</body>
</html>
